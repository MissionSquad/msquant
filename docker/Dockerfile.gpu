ARG BASE_IMAGE=nvcr.io/nvidia/pytorch:24.06-py3
FROM ${BASE_IMAGE}

ENV DEBIAN_FRONTEND=noninteractive \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1 \
    HF_HOME=/workspace/hf \
    HF_DATASETS_CACHE=/workspace/hf/datasets \
    HF_HUB_ENABLE_HF_TRANSFER=1 \
    PYTHONUNBUFFERED=1

# System packages (if needed, keep minimal)
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/*

# Upgrade pip
RUN pip install --upgrade pip

# Install Python dependencies
RUN pip install "datasets"

RUN pip install "pandas" "huggingface_hub" "hf_transfer" "tqdm"

RUN pip install "accelerate" "safetensors"

RUN pip install "nicegui>=2.0.0" "nicegui-highcharts>=0.2.0" 
      
RUN pip install "vllm>=0.11.0" 

RUN pip install "transformers>=4.52.0"

RUN pip install "llmcompressor"

WORKDIR /workspace

# Copy source
# Assuming our code is in ./src/msquant. Adjust if different.
COPY src /workspace/src
ENV PYTHONPATH=/workspace/src

# Expose NiceGUI port
EXPOSE 8080

# Entrypoint
CMD ["python", "-m", "msquant.app.main"]
